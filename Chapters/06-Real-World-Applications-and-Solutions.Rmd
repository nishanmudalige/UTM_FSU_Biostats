---
editor_options: 
  markdown: 
    wrap: 72
---

```{r plot_setup, include=FALSE}
library(deSolve)    # For solving differential equations
library(ggplot2)    # For plotting
library(tidyr)      # For data reshaping
library(dplyr)

knitr::opts_chunk$set(
  fig.width = 7,       # Default figure width (inches) when R creates it
  fig.asp = 0.618,     # Aspect ratio (height/width). The 0.618 is the golden ratio.
  out.width = "80%",   # Size of the figure in your final output document
  fig.align = "center", # Alignment
  fig.cap = "Figure"    # Base text for captions (bookdown will add numbers)
)
```

# Extended Compartmental Models: Real World Applications and Solutions

## Introduction

In this chapter, we will discuss and solve in detail varying complext
SIR-type compartmental models, such as SAIR, SVIR, and SIQR. These
models are derived and solved from pre-existing scholarly articles and
experiments in which the parameters, variables, and differential
equations that defined the study are provided. In this, we can apply our
knowledge and techniques from previous chapters to determine stability
and analyze different compartmental models. It is important to note that
in previous chapters, we discussed theoretical techniques, which can be
applied here, but also are defined for every equilibria, such as the DFE
and EE. In these examples below, not all are specifically defined for
each equilibria due to varying reasons, specfically due to the closed
system nature of the experiments, not allowing a disease to persist in
regard to the model.

## The SVIR Model

This model is based on the parameters and variables defined in the
article cited. [@ramponi2024] The model takes into account vaccination
rate, vaccine effectiveness, and vaccine induced decline in the immune
rate.



```{r vsirdiagram, echo=FALSE, engine='tikz', fig.ext='png', out.width='60%', fig.cap='The VSIR compartmental model.'}
\usetikzlibrary{arrows.meta, positioning}

\begin{tikzpicture}[
    block/.style={rectangle, draw, rounded corners, minimum width=2.3cm, minimum height=1.2cm, text centered, font=\Large},
    arrow/.style={-Latex, thick}
]

% Nodes
\node (V) at (0,0)   [block, fill=red!20]     {$V(t)$};
\node (S) [right=3.2cm of V, block, fill=green!20] {$S(t)$};
\node (I) [right=3.2cm of S, block, fill=yellow!30] {$I(t)$};
\node (R) [right=3.2cm of I, block, fill=orange!30] {$R(t)$};

% Flows
\draw[arrow] (V) -- node[midway, above] {$\delta V$} (S);
\draw[arrow] (S) -- node[midway, below] {$\gamma S$} (V);
\draw[arrow] ([yshift=1.3cm]S.north) -- node[midway,right] {$\Lambda$} (S.north);
\draw[arrow] (S.south) -- ++(0,-1.0) node[midway,right] {$dS$};
\draw[arrow] (V.south) -- ++(0,-1.0) node[midway,right] {$dV$};
\draw[arrow] (I.south) -- ++(0,-1.0) node[midway,left] {$dI$};
\draw[arrow] (I.south) -- ++(1,-1.2) node[midway,right] {$\alpha I$};
\draw[arrow] (R.south) -- ++(0,-1.0) node[midway,left] {$dR$};
\draw[arrow] (S) -- node[midway, above] {$\beta S I$} (I);
\draw[arrow] (V.north) -- ++(0,1) -- ++(6.4,0) -- (I.north) node[midway, above] {$(1-\theta)\beta S I$};
\draw[arrow] (I) -- node[midway, above] {$b I$} (R);

\end{tikzpicture}
```



### Model Formulation

With $N(t)$ representing the total pupulation it can also be divided in
to the four compartments: susceptible, vaccinated, infected and
recovered.

Therefore, $N(t) = V(t) + S(t) + I(t) + R(t)$

The model assumes that after vaccination, people will develop immunity
but after some time they will become susceptible again as the immunity
wares off. Based on this, the following parameters can be defined:

- $\Lambda$ : susceptible individuals recruited by immigration/birth 

- $\beta$ : effective contact rate between susceptible and infected 
individuals 

- $d$ : natural death rate 

- $\theta$ : vaccine effectiveness rate 

- $\gamma$ : vaccination rate of susceptible individuals 

- $b$ : cure rate of infected individuals 

- $\alpha$ : disease induced mortality 

- $\delta$ : loss rate of immunity

The epidemic dynamical model is given by the following four models :

$$ 
\begin{align*}
\frac{dV}{dt} &= \gamma S -(1- \theta) \beta VI - (\gamma +d)V \\
\frac{dS}{dt} &= \Lambda + \delta V - \beta SI - (\gamma + d)S \\
\frac{dI}{dt} &= \beta SI + (1- \theta) \beta VI - (d+ \alpha + b)I \\
\frac{dR}{dt} &= bI - dR\\
\end{align*}
$$


### Solving for the Basic Reproduction Number

From here the basic reproduction number, $R_0$, can be solved for using
the next generation matrix method. When $\theta = \gamma = \delta =0$, the system is then the SIR model essentially. Finding the regeneration and transfer matrix then gives:

$$
F_0 = \begin{bmatrix} \beta SI \\ 0 \\ 0 \end{bmatrix},
V_0 = \begin{bmatrix} (d+ \alpha + b) I \\ -bI + dR \\ - \Lambda + \beta SI +dS \end{bmatrix}
$$

The next step would be to differentiate $F_0$ and $V_0$ and calculate
the value of $E_{00} = (S_{00},0,0) = (\frac{\Lambda}{d} , 0,0)$ which
is at the DFE of the SIR model.

It can be found that

$$ 
F_0 = \begin{bmatrix} \beta S_{00} & 0 & 0 \\ 0 & 0 & 0 \\ 0 & 0 & 0 \end{bmatrix},
V_0 = \begin{bmatrix} (d + \alpha + b) & 0 & 0 \\ -b & d & 0 \\ \beta S_0 & 0 & d \end{bmatrix}
$$

Since $R_0 = \rho (F_0 V^{-1}_0)$,

$$
R_0 = \frac {\beta S_{00}}{d+b+\alpha } = \frac{\beta \Lambda}{d(d+b+ \alpha)}
$$

Using this same process to solve for the SVIR. system's disease free equlibrium, the derivatives can be set to 0, that is,

$E_0 = (V_0, S_0, 0,0) = (\frac{\Lambda \gamma} {d (\delta + d +\gamma)} , \frac {\Lambda (\delta + d)} {d (\delta + d +\gamma)}, 0,0 )$

Where $x = (I, R, V, S)^T$, the regeneration matrix, $F$ and the
transfer matrix, $V$ can be found to be :

$$ 
F = \begin{bmatrix} \beta SI + (1- \theta) \beta VI \\ 0\\ 0 \\ 0 \end{bmatrix},
V =\begin{bmatrix} (d + \alpha +b) I \\ -bI + dR\\ -\gamma S + (1-\theta) \beta VI +(\delta +d) V \\ - \Lambda - \delta V + \beta SI + (\gamma +d)S \end{bmatrix}
$$

### Computing the Basic Reproduction Number for the SVIR Model

To compute the basic reproduction number using the next-generation
method, we separate the system into:

-   **new infection terms**, denoted by $\mathcal{F}$\
-   **all other transitions**, denoted by $\mathcal{V}$

The system state is ordered as:

$$
x = (I, R, V, S)^T
$$

From the SVIR model, only the infected class $I$ receives new
infections. Therefore, the new infection terms are:

$$
\mathcal{F} =
\begin{bmatrix}
\beta SI + (1-\theta)\beta V I\\
0\\
0\\
0
\end{bmatrix}
$$

All other terms in the system are collected into the transition matrix
$\mathcal{V}$:

$$
\mathcal{V} =
\begin{bmatrix}
(d + \alpha + b)I \\
-bI + dR\\
-\gamma S + (1-\theta)\beta V I + (\delta + d)V \\
-\Lambda - \delta V + \beta S I + (\gamma + d)S
\end{bmatrix}
$$


### Linearization Around the Disease-Free Equilibrium

The disease-free equilibrium (DFE) for the SVIR model is:

$$
E_0 = (V_0, S_0, 0, 0)
$$

where:

$$
V_0 = \frac{\Lambda\gamma}{d(\delta + d + \gamma)}, \quad
S_0 = \frac{\Lambda(\delta + d)}{d(\delta + d + \gamma)}
$$

We now compute the Jacobians $D\mathcal{F}(E_0)$ and
$D\mathcal{V}(E_0)$.


### Jacobian of $\mathcal{F}$

Only the first component of $\mathcal{F}$ is non-zero:

$$
\mathcal{F}_1 = \beta SI + (1-\theta)\beta V I
$$

Taking partial derivatives:

$$
\frac{\partial \mathcal{F}_1}{\partial I} = \beta S + (1-\theta)\beta V, \quad
\frac{\partial \mathcal{F}_1}{\partial R} = 0
$$

Thus, the Jacobian evaluated at the DFE is:

$$
D\mathcal{F}(E_0)=
\begin{bmatrix}
\beta S_0 + (1-\theta)\beta V_0 & 0\\
0 & 0
\end{bmatrix}
$$

We denote this upper-left block as $F$.



### Jacobian of $\mathcal{V}$

The first two components of $\mathcal{V}$ involve the infected
subsystem:

$$
\mathcal{V}_1 = (d + \alpha + b)I, \quad
\mathcal{V}_2 = -bI + dR
$$

Taking partial derivatives:

$$
\frac{\partial \mathcal{V}_1}{\partial I} = d + \alpha + b, \quad
\frac{\partial \mathcal{V}_2}{\partial I} = -b, \quad
\frac{\partial \mathcal{V}_2}{\partial R} = d
$$

Thus, the upper-left block of $D\mathcal{V}(E_0)$ is:

$$
V =
\begin{bmatrix}
d + \alpha + b & 0\\
-b & d
\end{bmatrix}
$$

Lower blocks exist for the vaccinated and susceptible compartments, but
they do not affect the computation of the reproduction number and are
dropped.



### Forming the Next-Generation Matrix

The next-generation matrix is:

$$
FV^{-1}
$$

First, compute the inverse of $V$. For a matrix:

$$
\begin{bmatrix}
a & 0\\
c & d
\end{bmatrix}
$$

the inverse is:

$$
\frac{1}{ad}
\begin{bmatrix}
d & 0\\
-c & a
\end{bmatrix}
$$

Applying this formula gives:

$$
V^{-1} =
\frac{1}{d(d+\alpha + b)}
\begin{bmatrix}
d & 0\\
b & d+\alpha + b
\end{bmatrix}
$$

Now multiply:

$$
FV^{-1} =
\begin{bmatrix}
\frac{\beta\left(S_0 + (1-\theta)V_0\right)}{d+\alpha + b} & 0\\
0 & 0
\end{bmatrix}
$$


### Computing the Reproduction Number

The basic reproduction number is the dominant eigenvalue (spectral
radius) of $FV^{-1}$:

$$
R_{\text{vac}} =
\frac{\beta\left(S_0 + (1-\theta)V_0\right)}{d+\alpha + b}
$$

Substituting the formulas for $S_0$ and $V_0$:

$$
S_0 = \frac{\Lambda(\delta + d)}{d(\delta + d + \gamma)}, \quad
V_0 = \frac{\Lambda\gamma}{d(\delta + d + \gamma)}
$$


### Interpretation

-   $\dfrac{\beta}{d+\alpha+b}$ represents the expected number of
    infections produced by an infectious individual before leaving the
    infected class through recovery or death.\
-   $S_0 + (1-\theta)V_0$ is the *effective number of individuals at
    risk*, because:
    -   susceptible individuals contribute fully,
    -   vaccinated individuals contribute only by the fraction
        $(1-\theta)$ that the vaccine fails.

Thus:

-   A higher vaccination rate $\gamma$,\
-   a more effective vaccine $\theta$,

both reduce $R_{\text{vac}}$, helping to prevent the spread of
infection.

## The SIQR Model

This model is based on the parameters and variables defined in the
article cited. [@kalachev2022].

It is important to note that the authors states their limitations, as
they do not include an E, Exposed, compartment. This means that the
complexities of the case in question, COVID-19, is not fully modeled.
However, for our purposes, this pre-existing model provides definitive
parameters and variables to be manipulated and solved.

```{r siqrdiagram, echo=FALSE, fig.align='center', engine='tikz', out.width='50%', fig.ext='png', fig.cap='The SIQR compartmental model.'}
\usetikzlibrary{arrows.meta, positioning}

\begin{tikzpicture}[block/.style={rectangle, draw, minimum width=1.5cm, minimum height=1cm, text centered, font=\Large},
    arrow/.style={-Latex, thick}]

% Nodes
\node (S) at (0,0) [block] {S};
\node (I) [right=2cm of S, block] {I};
\node (Q) [right=2cm of I, block] {Q};
\node (R) [right=2cm of Q, block] {R};

% Arrows
% S to I
\draw [arrow] (S) -- node [midway, above] {$\alpha SI$} (I);

% I to R
\draw [arrow] (I) -- node [midway, above] {$\beta I$} (Q);

\draw [arrow] (Q) -- node [midway, above] {$\gamma Q$} (R);

\end{tikzpicture}
```

### Defining the Parameters

- $\alpha$: infection rate

- $\beta$: quarantine rate

- $\gamma$: recovery rate

Beginning with X, the vector of disease compartments. For the SIQR
model, $X = \begin{bmatrix} I\\ Q\\ \end{bmatrix}$

Refer back to the definitions of the new infection vector $F(x)$ and the
transition vector $V(x)$ in (*Chapter* \@ref(sec:ngmparameters)).

### Defining the Disease Free Equilibrium

Due to the closed system definition of the article, this SIQR
Compartmental Model can only be solved at the DFE. This is due to the
nature of a closed system in which the disease has already dissipated,
thus, the Endemic Equilibrium cannot exist. However, modifications to
create an open system with birth and death rates incorporated, an
Endemic Equilibrium can then be solved for.

The Disease Free Equilibrium exists when all infected compartments (I
and Q), are set to 0. Thus, $I=0$ and $Q=0$. So: $$
\begin{align*}
\dot{S} &= -\alpha S I = 0\\
\dot{I} &= \alpha S I - \beta I = 0 \\
\dot{Q} &= \beta I - \gamma Q = 0 \\
\dot{R} &= \gamma Q = 0 \\
\end{align*}
$$ At the DFE:

-   $\dot{S}$ is true when $I=0$
-   $\dot{I}$ is true when $I=0$
-   $\dot{Q}$ is true when $I=0$ and $Q=0$
-   $\dot{R}$ is true when $Q=0$

Since there are no infections: $I=Q=R=0$ This means that for
$N=S+I+Q+R$, $N=S$ due to our earlier statements So at the DFE for the
$(S,I,Q,R) = (S,0,0,0) = (N,0,0,0)$

**It is important to note that we normally use $\beta$ for the transmission parameter, while in this example it is $\alpha$. Additionally $\beta$ becomes the quarantine rate and $\gamma$ remains as the recovery rate.**

### Solving the SIQR Model

#### Defining F and V Matrices

Recall: that for the SIQR model the disease compartments are I and Q:

$\dot{X} = \begin{bmatrix} \dot{I}\\ \dot{Q}\\ \end{bmatrix}$

In order to define the distinction between new infections and
transferred compartments, we create 2 matrices: Transmission (F) and
Transition (V)

-   Transmission Matrix (F)
    -   In this Matrix, only compartments in which new infections are
        created $$
        \begin{align*}
        \ F(x) &= \begin{bmatrix} \dot{I}\\ \dot{Q}\\ \end{bmatrix} \\
        \ F(x) &= \begin{bmatrix} \alpha S I - \beta I \\ \beta I - \gamma Q \\ \end{bmatrix} \\
        \ F(x) &= \begin{bmatrix} \alpha S I \\ 0 \\ \end{bmatrix}
        \end{align*}
        $$
-   Transition Matrix (V)
    -   In this Matrix, using $V = V^- + V^+$, we can find the transfer
        of infected individuals in and out of infected compartments
    -   We can see this transfer as each of the values stated below
        leave/subtracted from a differential equation of a compartment
        and enter/added to the differential equation of the next
        compartment $$
        \begin{align*}
        \ V(X) &= \begin{bmatrix} \beta I \\ -\beta I + \gamma Q \\ \end{bmatrix} \\
        \end{align*}
        $$

Referring back to (*Chapter*\@ref(sec:ngmparameters)) once again for the
equation for $\dot{X} = F(x) - V(x)$, we combine these matrices into:

$$
\begin{align*}
\ \dot{X} &= \begin{bmatrix} \alpha S I \\ 0 \\ \end{bmatrix} - \begin{bmatrix} \beta I \\ -\beta I + \gamma Q \\ \end{bmatrix}
\end{align*}
$$ For simplicity in later calculations: $$
\begin{align*}
\ F(x) &= \begin{bmatrix} \alpha S I \\ 0 \\ \end{bmatrix} = \begin{bmatrix} F_1 \\ F_2 \end{bmatrix} \\
\ V(x) &= \begin{bmatrix} \beta I \\ -\beta I + \gamma Q \\ \end{bmatrix} = \begin{bmatrix} V_1 \\ V_2 \end{bmatrix}
\end{align*}
$$

#### Taking the Jacobian Matrix of F and V

Let the Jacobian of F(x) be **F**.

$$
\boldsymbol{F} = J_F (x) = \begin{bmatrix} 
\frac{\partial F_1}{\partial E} & \frac{\partial F_1}{\partial I} \\
\frac{\partial F_2}{\partial E} & \frac{\partial F_2}{\partial I} \\
\end{bmatrix}
= \begin{bmatrix} 
\alpha S & 0\\
0 & 0 \\
\end{bmatrix}
$$ At DFE, $S = 1$

-   This is found by our earlier definition of the DFE.
    -   At the DFE for $(S,I,Q,R) = (S,0,0,0) = (N,0,0,0)$
    -   Since Population $"N"=1$ and $S=N$, then $S=1$
-   So after subsituting $S=1$:

$$
J_F (x) 
= \begin{bmatrix} 
\alpha S & 0 \\
0 & 0 \\
\end{bmatrix}
$$

Let the Jacobian of V(x) be **V**. $$
\boldsymbol{V} = J_V (x) = \begin{bmatrix} 
\frac{\partial V_1}{\partial E} & \frac{\partial V_1}{\partial I} \\
\frac{\partial V_2}{\partial E} & \frac{\partial V_2}{\partial I} \\
\end{bmatrix}
= \begin{bmatrix} 
\beta & 0 \\
-\beta & \gamma \\
\end{bmatrix}
$$

#### Finding the Next Generation Matrix

Refer to (*Chapter * \@ref(sec:ngm)) where the NGM for the SEIR model is
found. We will be using a similar structure once again.
$NGM = \boldsymbol{F} \boldsymbol{V}^{-1}$

Thus: $$
\boldsymbol{F}
= \begin{bmatrix} 
\alpha S & 0 \\
0 & 0 \\
\end{bmatrix}
$$ For $\boldsymbol{V}^{-1}$, we use the same inverse matrix rule.

\begin{align*}
\boldsymbol{V} &= 
\begin{bmatrix} 
\beta & 0 \\
-\beta & \gamma \\
\end{bmatrix}\\

\boldsymbol{V}^{-1} &= \frac{1}{ad-bc} \begin{bmatrix} d & -b \\ -c & a \\ \end{bmatrix} \\
\boldsymbol{V}^{-1} &=\frac{1}{\beta \gamma} 
\begin{bmatrix} 
\gamma & 0 \\
\beta & \beta \\
\end{bmatrix}\\
\boldsymbol{V}^{-1} &= \begin{bmatrix} 
\frac{1}{\beta} & 0 \\
\frac{1}{\gamma} & \frac{1}{\gamma} \\
\end{bmatrix}\\
\end{align*}

So $\boldsymbol{F} \boldsymbol{V}^{-1}$ is: $$
\begin{align*}
\boldsymbol{F} \boldsymbol{V}^{-1} &= \begin{bmatrix} 
\alpha S & 0 \\
0 & 0 \\
\end{bmatrix} \begin{bmatrix} 
\frac{1}{\beta} & 0 \\
\frac{1}{\gamma} & \frac{1}{\gamma} \\
\end{bmatrix} \\
\boldsymbol{F} \boldsymbol{V}^{-1} &= \begin{bmatrix} 
\frac{\alpha S}{\beta} & 0 \\
0 &0  \\
\end{bmatrix}
\end{align*}
$$

#### Calculating $R_0$ and Defining Stability

As stated previously in (*Chapter* \@ref(sec:ngm)), $R_0$ is the
spectral radius of the Next Generation Matrix
$\ \boldsymbol{F} \boldsymbol{V}^{-1}$ $$
det \left( \begin{bmatrix} 
\frac{\alpha S}{\beta} - \lambda & 0 \\
0 & - \lambda \\
\end{bmatrix} \right)
= - \lambda \left( \frac{\alpha S}{\beta} - \lambda \right)
$$ Let $- \lambda \left( \frac{\alpha S}{\beta} - \lambda \right) = 0$
($\lambda_1$ and $\lambda_2$ respectively)

So $\lambda_1 = 0$ and $\lambda_2 = \frac{\alpha S}{\beta}$. $\lambda_2$
is the largest eigenvalue, so $R_0 = \frac{\alpha S}{\beta}$.

Thus:

-   If $R_0 < 1$ then the DFE is stable, and the disease dies out

    -   This means that $\alpha S < \beta$

-   If $R_0 > 1$ then the DFE is unstable, and an epidemic occurs

    -   This means that $\alpha S > \beta$
    
#### Fitting Data to the SIQR Model

Throughout this textbook, we have discussed how to solve and understand varying models on a theoretical level. However; we are also able to fit these models to data in with certain datasets. To do this, we will use a very commonly used example in the world of applied epidemiology, the 1978 Influenza Outbreak in a British Boarding School. The data contained total cases, quarantined defined as "Confined to Bed," and Recovering defined as "Convalescent." This was a closed system and contained detail reports to understand what occured using our modern techniques and models. Doing so allows us to map the data into the variables of our models and understand the situation from which our data was recorded.

- Parameter Values

  - Our normal parameter values $\beta, \gamma, \alpha$ are derived using a MATLAB Optimization Toolbox
  
  - By giving the solver the total population, N, which is 763 in this scenario, and setting the initial infected, I(0) equal to 1, the software can create predicted curves
  
  - By minimizing the Standard Squared Error between the predicted curves and data points, the values of the parameters can be found

- Fitting the SIQR Model

  - When fitting this model, there were two clear ways in which we could go about it
    
    - Scenario 1: Combine both the I and Q compartments, so that the individuals identified as infected are active cases and  not immediately quarantined and can still spread the disease, before becoming quarantined
    
    - Scenario 2: Fit the model to only Q, so that the individuals identified as "Confined to Bed" are immediately quarantined and thus, are not able to continue spreading the disease
    
      - This accounts for the time lag between being infected and quarantined, so that we can model the inital spike of disease in the population, I, occuring before they transfer to quarantine, Q, and predicting the transmission of disease during the period between the transfer

  - Using the methodology of Scenario 2, we are able to find our parameters using the previously described processes:

    - $N$ = 763
    
    - $\alpha$ = .00297
    
    - $\beta$ = .79
    
    - $\gamma$ = .24
  
  - Using these parameters, and fitting the data, the model reveals, as expected, that the Infected compartment spikes before the quarantined compartment, accounting for spread of disease before transferring to the Quarantined compartment. Below is a time series plot showing these relationships.

```{r siqrplot, echo=FALSE, fig.align='center', out.width='60%', fig.cap='Time series plot of SIQR model at endemic equilibrium, simulated with parameter values.'}
# Define the SIQR model function
siqr_model <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    # Differential equations
    dS <- -alpha * S * I
    dI <- alpha * S * I - beta * I
    dQ <- beta * I - gamma * Q
    dR <- gamma * Q
    
    list(c(dS, dI, dQ, dR)) # Return the rates of change
  })
}

# Set parameters
N <- 763
siqr_param <- c(alpha = 0.00297, beta = 0.79, gamma = 0.24)

# Initial conditions (assuming 1 initial infected, rest susceptible)
siqr_initial <- c(S = N-1, I = 1, Q = 0, R = 0)

# Time points to solve for (0 to 100 days, steps of 0.1)
times <- seq(0, 100, by = 0.1)

# Solve the differential equations
siqr_output <- ode(y = siqr_initial, times = times, func = siqr_model, parms = siqr_param)

# Convert to data frame
siqr_results <- as.data.frame(siqr_output)

# PLOT TIME SERIES PLOT
# Reshape data from wide to long format for ggplot2
siqr_results <- pivot_longer(siqr_results, cols = c(S, I, Q, R), 
                             names_to = "Compartment", values_to = "Population")

# Create the time series plot
ggplot(siqr_results, aes(x = time, y = Population, color = Compartment)) +
  geom_line(linewidth = 1.2) +
  labs(subtitle = paste0("N = ", N, ", α = ", siqr_param["alpha"], 
                         ", β = ", siqr_param["beta"], ", γ = ", siqr_param["gamma"]),
       x = "Time (days)",
       y = "Population (N)",
       color = "Compartment") +
  scale_color_manual(values = c("S" = "cornflowerblue",      # Susceptible
                                "I" = "tomato",       # Infected
                                "Q" = "darkgoldenrod1",    # Quarantined
                                "R" = "dodgerblue4")) +  # Recovered
  theme_minimal() +
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
```

Reference: [@kalachev2022]

#### Complex Models Vs. Parsimony in Real World Situations

As we have discussed, models may be too complex to fit the data. Key distinctions may be missing, which are vital to defining compartmental-specific data. In these scenarios, models are reduced to present a more general model while still being capable of great predictive power. In this specific scenario, the authors dive into attempting to use the SIQR model to use readily available data to define the perfect trends and relationships of COVID-19 in Missoula County, Montana, USA.

The authors state how the available data for one of the applied cases of the model included Active and New cases. However, an issue arose since the data values are not able to define $\gamma$. This meant that individuals moved from Q to R were not defined, and thus, it was difficult to determine the transition number from individuals leaving the compartment. An individual might become recovered or quarantined but none of these outcomes are defined. 

Because the data could not effectively be fit to the SIQR model, the author's decided to reduce the model to an SIR model. In this situation, the Q and R compartments would be combined, resolving the issue of the unclear distinction between the two compartments. While this does remove the dynamics between quarantine and recovery, and removing the role that quarantine plays in the context, reducing to an SIR model is still the most effective choice. The SIR model allows for a powerful model to be utilized due to fewer parameters, preventing over fitting. While the SIQR model would have given more precise results with distinctions between the Q and R compartments, using an SIR model still allows for a general trend to be established about the spread of the disease in this certain population and case.


## The SAIR Model

SAIR model is a four compartment model that considers asymptomatic infected individuals (compartment "A") as separate from the symptomatic individuals (compartment "I"). 

In this section we will use the NGM to solve an example of SAIR that models COVID-19. This example was modified from a paper by Ouyang et al. (2025) [@ouyang2025], and it should be noted that the model includes parameters for vital dynamics (birth, death) and vaccination. This example showcases how models can become increasingly complex to solve and interpret when more parameters are involved. See Figure \@ref(fig:sairdiagram) for the SAIR compartmental model diagram. 

### Defining the Parameters

```{r sairdiagram, echo=FALSE, fig.align='center', engine='tikz', out.width='60%', fig.ext='png', fig.cap='The SAIR compartmental model.'}
\begin{tikzpicture}[node distance=4cm,>=stealth,thick]

% Nodes
\node[draw, minimum width=2cm, minimum height=1cm] (S) {$S$};
\node[draw, minimum width=2cm, minimum height=1cm, right of=S, yshift=50] (A) {$A$};
\node[draw, minimum width=2cm, minimum height=1cm, above of=A, yshift=-50] (I) {$I$};
\node[draw, minimum width=2cm, minimum height=1cm, right of=A, yshift=-50] (R) {$R$};

% empty nodes
\node[draw=none, minimum width=2cm, minimum height=1cm, left of=S, xshift=30] (lambda) {};
\node[draw=none, minimum width=2cm, minimum height=1cm, below of=S, yshift=60] (muS) {};
\node[draw=none, minimum width=2cm, minimum height=1cm, above of=R, xshift=-30, yshift=-65] (muA) {};
\node[draw=none, minimum width=2cm, minimum height=1cm, below of=R, yshift=60] (muR) {};
\node[draw=none, minimum width=2cm, minimum height=1cm, above of=I, yshift=-60] (muI) {};
\node[draw=none, minimum width=2cm, minimum height=1cm, right of=I, xshift=-30] (thetaI) {};

% Arrows between compartments
\draw [->] (S) -- (A) node[midway, right, yshift = -7] {$(1-p) \beta (I + \alpha A)$};
\draw [->] (A) -- (R) node[midway, above, xshift=5] {$\gamma A$};
\draw [->] (S) -- (I) node[midway, above, xshift=-30] {$p \beta(I + \alpha A)$};
\draw [->] (I) -- (R) node[midway, above, xshift=30] {$uI / (1+kI)$};
\draw [->] (S) -- (R) node[midway, below] {$\delta S$};
\draw [->] (A) -- (I) node[midway, right] {$\epsilon A$};

% Arrows for vital dynamics
\draw [->] (lambda) -- node[midway, above] {$\Lambda$} (S);
\draw [->] (S) -- node[midway, right] {$\mu S$} (muS);
\draw [->] (A) -- node[midway, above, xshift=-2] {$\mu A$} (muA);
\draw [->] (R) -- node[midway, right] {$\mu R$} (muR);
\draw [->] (I) -- node[midway, right] {$\mu I$} (muI);
\draw [->] (I) -- node[midway, above] {$\theta I$} (thetaI);

\end{tikzpicture}
```

**SAIR Model Parameters:**

- $p$: proportion of population that shows symptoms ($0 < p < 1$)

  - $(1-p)$: proportion of population that does not show symptoms

- $\beta(I+\alpha A)S$: new infection

  - $\beta$: transmission rate

  - $\alpha$: relative infectivity of asymptomatic infected (A) to symptomatic infected (I) ($0 < a < 1$)
        
- $\gamma$: rate of the asymptomatic infected individuals' self-healing (producing antibodies for resistance to diseases) 

- $\epsilon$: rate of the asymptomatic infected individuals showing symptoms (if resistance to disease is poor)

- $\frac{uI}{1+kI}$: saturated treatment function represented by the Holling Type 2 Functional Response [@real1977], which considers saturation of treatment rate when the numbers of infected are high.
  - $u$: cure rate of the infected individual
  - $k$: handling time
  - $\frac{u}{k}$: maximal treatment capacity, due to limited medical resources or handling time 

- $\delta$: immunization rate of susceptible population from vaccination (this model considers vaccination without including a fifth compartment)

- vital dynamics: 

  - $\Lambda$: recruitment rate of susceptible population (e.g. births, immigration)

  - $\mu$: natural death rate per capita (all deaths unrelated to the disease)
  
  - $\theta$: mortality rate of the disease (all deaths caused by the disease)

We define the **differential equations for the SAIR Model** as follows: 

$$
\begin{align*}
\ \dot{S} &= \Lambda -\beta(I+\alpha A)S - (\mu + \delta) S \\
\ \dot{A} &= (1-p)\beta(I+\alpha A)S-(\gamma + \epsilon + \mu)A \\
\ \dot{I} &= p\beta(I+\alpha A)S+\epsilon A - \frac{uI}{1+kI} - (\mu + \theta)I \\
\ \dot{R} &= \delta S + \frac{uI}{1+kI} + \gamma A - \mu R \\
\ \end{align*}
$$

For the SAIR model, $\dot{X} = \begin{bmatrix} \dot{A} \\ \dot{I}\\ \end{bmatrix}$, where X is the matrix representing the infected compartments. 

### Defining the Disease Free Equilibrium (DFE)

The Disease Free Equilibrium exists when all infected compartments (A and I), are set to 0. i.e. $A=0$ and $I=0$. (*Definition* \@ref(def:DFE)).

$$
\begin{align*}
\ \dot{S} &= \Lambda -\beta(I+\alpha A)S - (\mu + \delta) S &= 0 \\
\ \dot{A} &= (1-p)\beta(I+\alpha A)S-(\gamma + \epsilon + \mu)A &= 0 \\
\ \dot{I} &= p\beta(I+\alpha A)S+\epsilon A - \frac{uI}{1+kI} - (\mu + \theta)I &= 0 \\
\ \dot{R} &= \delta S + \frac{uI}{1+kI} + \gamma A - \mu R &= 0 \\
\ \end{align*}
$$

By setting all of the differential equations to 0, we obtain that initial $S$ is $S = \frac{\Lambda}{\mu+\delta}$. 
Note that since we allow the population to vary by vital dynamics, we get $N \neq 1$. 

Therefore, at the DFE: $(S, A, I, R) = (\frac{\Lambda}{\mu+\delta}, 0, 0, \frac{\delta\Lambda}{\mu(\mu+\delta)})$

### Solving SAIR Model with NGM 

We begin by finding $R_0$, starting with the X matrix. 


$$
\begin{align*}
\ \dot{X} &= \begin{bmatrix} \dot{A} \\  \dot{I}\\ \end{bmatrix} \\
\ \dot{X} &= \begin{bmatrix} (1-p)\beta(I+\alpha A)S-(\gamma + \epsilon + \mu)A \\ 
p\beta(I+\alpha A)S+\epsilon A - \frac{uI}{1+kI} - (\mu + \theta)I \end{bmatrix} \\
\end{align*}
$$

So then, from X we obtain: $\boldsymbol{F} = \begin{bmatrix} (1-p)\beta(I+\alpha A)S \\ p\beta(I+\alpha A)S \end{bmatrix} = \begin{bmatrix} F_1 \\ F_2 \\ \end{bmatrix}$ and $\boldsymbol{V} = \begin{bmatrix} (\gamma + \epsilon + \mu)A \\ -\epsilon A + \frac{uI}{1+kI} + (\mu + \theta)I \end{bmatrix} = \begin{bmatrix} V_1 \\ V_2 \\ \end{bmatrix}$

Solving for the Jacobian matrices, we get: 

$$
\begin{align*}
\ \boldsymbol{F} &= J_F (x) = 
  \begin{bmatrix} \frac{\partial F_1}{\partial A} & \frac{\partial F_1}{\partial I} \\
  \frac{\partial F_2}{\partial A} & \frac{\partial F_2}{\partial I} \\ \end{bmatrix}
  = \begin{bmatrix} (1-p) \alpha \beta S & (1-p) \beta S \\ 
  (p) \alpha \beta S & p \beta S  \\\end{bmatrix} \\
\ \boldsymbol{V} &= J_V (x) = 
  \begin{bmatrix} \frac{\partial V_1}{\partial A} & \frac{\partial V_1}{\partial I} \\
  \frac{\partial V_2}{\partial A} & \frac{\partial V_2}{\partial I} \\ \end{bmatrix} 
  = \begin{bmatrix} \gamma + \epsilon + \mu & 0 \\ -\epsilon & \frac{u}{(1+kI)^2} + \mu + \theta \\ \end{bmatrix} \\
\end{align*}
$$

Since $I = 0$: 
$$
\boldsymbol{V} = \begin{bmatrix} \gamma + \epsilon + \mu & 0 \\ -\epsilon & u + \mu + \theta \\ \end{bmatrix}
$$

Then we can get: 
$$
\boldsymbol{V}^{-1} = 
  \frac{1}{ (u + \mu + \theta) (\gamma + \epsilon + \mu)} 
  \begin{bmatrix} u + \mu + \theta & 0 \\ \epsilon & \gamma + \epsilon + \mu \\ \end{bmatrix}
$$

Next, recall that: $NGM = \boldsymbol{F} \boldsymbol{V}^{-1}$

$$
\begin{align*}
\ \boldsymbol{F} \boldsymbol{V} ^{-1} &= 
  \begin{bmatrix} (1-p) \alpha \beta S & (1-p) \beta S \\
  (p) \alpha \beta S & p \beta S \\ \end{bmatrix} 
  \frac{1}{ (u + \mu + \theta) (\gamma + \epsilon + \mu)} 
  \begin{bmatrix} u + \mu + \theta & 0 \\ \epsilon & \gamma + \epsilon + \mu \\ \end{bmatrix} \\
\ &= 
  \begin{bmatrix} (1-p) \alpha \beta S & (1-p) \beta S \\
  (p) \alpha \beta S & p \beta S \\ \end{bmatrix}
  \begin{bmatrix} \frac{1}{\gamma + \epsilon + \mu} & 0 \\ \frac{\epsilon}{ (u + \mu + \theta) (\gamma + \epsilon + \mu)} & \frac{1}{u + \mu +\theta} \\ \end{bmatrix} \\
\ &= 
  \begin{bmatrix} (\frac{1}{\gamma + \epsilon + \mu})(1-p) \alpha \beta S + (\frac{\epsilon}{ (u + \mu + \theta) (\gamma + \epsilon + \mu)}) (1-p) \beta S 
  & (\frac{1}{u + \mu +\theta}) (1-p) \beta S \\
  (\frac{1}{\gamma + \epsilon + \mu})p \alpha \beta S + (\frac{\epsilon}{ (u + \mu + \theta) (\gamma + \epsilon + \mu)}) p \beta S & (\frac{1}{u + \mu +\theta})p \beta S \\ \end{bmatrix} \\
\end{align*}
$$

Use the formula $det(J-\lambda I_n) = det(\lambda I_n -J) = 0$ to find the spectral radius, $R_0$.

$$
\begin{align*}
\ 0 &= det \left(  
  \begin{bmatrix} (\frac{1}{\gamma + \epsilon + \mu})(1-p) \alpha \beta S + (\frac{\epsilon}{ (u + \mu + \theta) (\gamma + \epsilon + \mu)}) (1-p) \beta S 
  & (\frac{1}{u + \mu +\theta}) (1-p) \beta S \\
  (\frac{1}{\gamma + \epsilon + \mu})p \alpha \beta S + (\frac{\epsilon}{ (u + \mu + \theta) (\gamma + \epsilon + \mu)}) p \beta S & (\frac{1}{u + \mu +\theta})p \beta S \\ \end{bmatrix} 
  -\lambda\begin{bmatrix} 1 & 0 \\ 0 & 1\end{bmatrix} \right) \\
\ 0 &= det \left(
  \begin{bmatrix} (\frac{1}{\gamma + \epsilon + \mu})(1-p) \alpha \beta S + (\frac{\epsilon}{ (u + \mu + \theta) (\gamma + \epsilon + \mu)}) (1-p) \beta S - \lambda
  & (\frac{1}{u + \mu +\theta}) (1-p) \beta S \\
  (\frac{1}{\gamma + \epsilon + \mu})p \alpha \beta S + (\frac{\epsilon}{ (u + \mu + \theta) (\gamma + \epsilon + \mu)}) p \beta S & (\frac{1}{u + \mu +\theta})p \beta S - \lambda \\ \end{bmatrix} 
  \right) \\
\ 0 &= \left( (\frac{1}{\gamma + \epsilon + \mu})(1-p) \alpha \beta S + (\frac{\epsilon}{ (u + \mu + \theta) (\gamma + \epsilon + \mu)}) (1-p) \beta S - \lambda \right)
\left( (\frac{1}{u + \mu +\theta})p \beta S - \lambda \right) - \left( (\frac{1}{u + \mu +\theta}) (1-p) \beta S \right) \left( (\frac{1}{\gamma + \epsilon + \mu})p \alpha \beta S + (\frac{\epsilon}{ (u + \mu + \theta) (\gamma + \epsilon + \mu)}) p \beta S \right) \\
\end{align*}
$$

Eventually, having substituted $S = \frac{\Lambda}{\mu+\delta}$ into the equation, we obtain the following: 

$$
R_0 = \frac{\beta \Lambda [(1-p)\alpha(u+\mu+\theta)+(1-p)\epsilon+p(\gamma+\epsilon+\mu)]}{(\mu+\delta)(\gamma+\epsilon+\mu)(u+\mu+\theta)}
$$

We interpret this $R_0$ as we have previously done: $R_0 > 1$ indicates continuous spread of the disease (EE is stable), and $R_0 < 1$ indicates that the disease will eventually die out (DFE is stable). 

### Example Parameters and Simulation 

The following parameter values were retrieved from the article by Ouyang et al. (2025) [@ouyang2025], and also considers some demographic data from the United States of America in 2020. 

- $p = 0.0065$ (proportion of symptomatic individuals)

- $\beta = 0.05$ (transmission rate)

- $\alpha = 0.00025$ (relative infectivity of asymptomatic individuals)

- $\gamma = 0.12$ (rate of asymptomatic self-healing)

- $\epsilon = 0.25$ (rate of asymptomatic individuals showing symptoms)

- $\delta = 0.04$ (immunization rate) 

- saturated treatment function: 

  - $u = 0.25$ (cure rate) 
  
  - $k = 20$ (handling time)

- vital dynamics: 

  - $\Lambda = 1$ (recruitment rate)

  - $\mu = 0.014$ (natural death rate)

  - $theta = 0.01$ (COVID-19 death rate)

By plugging these parameter values into the previously solved equation for $R_0$, we obtain $R_0 = 2.208 > 1$. Thus, we conclude that the endemic equilibrium is stable and the disease will persist. 

Figure \@ref(fig:sairplot) represents a simulation based on these parameter values that displays the populations in each compartment of the SAIR model over the period of 2 years.  

```{r sairplot, echo=FALSE, fig.align='center', , fig.align='center', out.width='60%', fig.cap='Time series plot of SAIR model at endemic equilibrium, simulated with parameter values.'}
# Define the SAIR model function
sair_model <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    # Differential equations
    dS <- Lambda - beta*(I+alpha*A)*S - (mu+delta)*S
    dA <- (1-p)*beta*(I+alpha*A)*S - (gamma+epsilon+mu)*A
    dI <- p*beta*(I+alpha*A)*S + epsilon*A - ( (u*I)/(1+k*I) ) - (mu+theta)*I
    dR <- delta*S + ( (u*I)/(1+k*I) ) + gamma*A - mu*R
    
    list(c(dS, dA, dI, dR)) # Return the rates of change
  })
}

sair_param <- c(Lambda = 1, beta = 0.05, alpha = 0.00025, mu = 0.014, 
                delta = 0.04, gamma = 0.12, p = 0.0065, epsilon = 0.25, 
                theta = 0.01, u = 0.25, k = 20) 

# calculate DFE:
Lambda <- 1
mu <- 0.014
delta <- 0.04

S0 <- Lambda/(mu+delta)
R0 <- (delta*Lambda) / (mu*(mu+delta))
N_dfe <- S0 + R0  # = Λ/μ

# Initial conditions: small outbreak with small A, I, and S slightly below DFE
sair_initial <- c(S = S0 * 0.99, A = 0.01, I = 0.01, R = R0)

# Time points to solve for (0 to 2-years simulation (daily steps)
times <- seq(0, 365 *2, by = 1)

# Solve the differential equations
sair_output <- ode(y = sair_initial, times = times, func = sair_model, parms = sair_param)

# Convert to data frame
sair_results <- as.data.frame(sair_output)

# Calculate derived quantities
sair_results <- sair_results %>% mutate(N = S + A + I + R, Day = time)

# PLOT TIME SERIES PLOT
p1 <- sair_results %>%
  pivot_longer(cols = c(S, A, I, R), names_to = "Compartment", values_to = "Count") %>%
  ggplot(aes(x = Day, y = Count, color = Compartment)) +
  geom_line(linewidth = 1.2, alpha = 0.8) +
  labs(subtitle = paste("β =", sair_param["beta"], ", α =", sair_param["alpha"],
                        ", p =", sair_param["p"], ", Λ =", sair_param["Lambda"], 
                        ", μ = ", sair_param["mu"], ", δ = ", sair_param["delta"],
                        ", ε = ", sair_param["epsilon"], ", γ = ", sair_param["gamma"],
                        ", θ = ", sair_param["theta"], ", u = ", sair_param["u"], ", 
                        k = ", sair_param["k"]),
       x = "Time (days)", y = "Population (N)") +
  scale_color_manual(values = c("S" = "cornflowerblue", 
                                "A" = "darkgoldenrod1",
                                "I" = "tomato", 
                                "R" = "dodgerblue4")) +
  theme_minimal() +
  theme(legend.position = "bottom")

p1
```

