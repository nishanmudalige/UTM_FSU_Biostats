---
editor_options: 
  markdown: 
    wrap: 72
---


```{r plot_setup_one, include=FALSE}
library(deSolve)    # For solving differential equations
library(ggplot2)    # For plotting
library(tidyr)      # For data reshaping
library(dplyr)

knitr::opts_chunk$set(
  fig.width = 7,       # Default figure width (inches) when R creates it
  fig.asp = 0.618,     # Aspect ratio (height/width). The 0.618 is the golden ratio.
  out.width = "80%",   # Size of the figure in your final output document
  fig.align = "center", # Alignment
  fig.cap = "Figure"    # Base text for captions (bookdown will add numbers)
)
```

# Next Generation Matrix

## Introduction to the Chapter

This chapter describes in depth the use of the **Next Generation Matrix (NGM) method**. This tool is used to calculate the $R_0$ value (*Definition* \@ref(def:R0)). Using the NGM achieves this this for multi-compartmental models (e.g. SEIR), by linearizing the system of differential equations around the Disease-Free Equilibrium (DFE)
(*Definition* \@ref(def:DFE)) and dividing the flow of disease (*Definition* \@ref(def:Flow)) into
what causes new cases and what accounts for everything else that happens to an infected person. It is also important to mention that these tools are not limited to specific models and can be used for a variety of models. 
This chapter will use the **SEIR model** as an example for applying the NGM method (recall the SEIR model from *Chapter* \@ref(sec:compartments)). 

## Definining the SEIR Model and Parameters {#sec:ngmparameters}

The SEIR model expands on our previous SIR model with the additional compartment "Exposed". This compartment represents individuals in the population that have been infected, but are not yet infectious. 

```{r seirdiagram, echo=FALSE, fig.align='center', engine='tikz', out.width='60%', fig.ext='png', fig.cap='The SEIR compartmental model.'}
\begin{tikzpicture}[node distance=3.2cm,>=stealth,thick]

% Nodes
\node[draw, minimum width=2cm, minimum height=1cm] (S) {$S$};
\node[draw, minimum width=2cm, minimum height=1cm, right of=S] (E) {$E$};
\node[draw, minimum width=2cm, minimum height=1cm, right of=E] (I) {$I$};
\node[draw, minimum width=2cm, minimum height=1cm, right of=I] (R) {$R$};

% Arrows
\draw[->] (S) -- (E) node[midway, above] {$\beta S I$};
\draw[->] (E) -- (I) node[midway, above] {$\delta$};
\draw[->] (I) -- (R) node[midway, above] {$\gamma I$};

\end{tikzpicture}
```

We define X as the vector of disease compartments. For the SEIR
model, $X = \begin{bmatrix} E\\ I\\ \end{bmatrix}$. Note that for the SIR model,
$X = \begin{bmatrix} I \end{bmatrix}$. 

Then we can have:
$$\frac{dX}{dt} = F(x) - V(x)$$

- $F(x)$ is a vector of the terms that lead to new infections

- $V(x) = V^- (x) -V^+ (x)$ where $V^- (x)$ and $-V^+ (x)$ contain all
other outputs and inputs, respectively, for each disease compartment

### Defining the Disease Free Equilibrium (DFE)

The Disease Free Equilibrium exists when all infected compartments $(I and E)$, are set to 0. i.e. $E=0$ and $I=0$.

$$
\begin{align*}
\ \dot{S} &= - \beta SI = 0\\ 
\ \dot{E} &= \beta SI - \delta E = 0 \\
\ \dot{I} &= \delta E - \gamma I = 0\\
\ \dot{R} &= \gamma I = 0\\ 
\end{align*}
$$
At the DFE:

- $\dot{S}$ is true when I=0
- $\dot{E}$ is true when I=0 and E=0
- $\dot{I}$ is true when E=0 and I=0
- $\dot{R}$ is true when I=0

Since there are no infections: $E=I=R=0$
This means that for $N=S+E+I+R$, $N=S$ due to our earlier statements
So at the DFE for the $(S,E,I,R) = (N,0,0,0)$

This is important for understanding later substitutions in the Chapter.

## Solving SEIR Model with NGM {#sec:ngm}

Recall: that for the SEIR model the disease compartments are E and I

$\dot{X} = \begin{bmatrix} \dot{E}\\ \dot{I}\\ \end{bmatrix}$

$$
\begin{align*}
\ \dot{S} &= - \beta SI \\ 
\ \dot{E} &= \beta SI - \delta E \\
\ \dot{I} &= \delta E - \gamma I \\
\ \dot{R} &= \gamma I \\ 
\end{align*}
$$

For the SIR model, $X = \begin{bmatrix} I \end{bmatrix}$
For the SEIR Model:

$$
\begin{align*}
\ \dot{X} &= \begin{bmatrix} \dot{E}\\ \dot{I}\\ \end{bmatrix} \\
\ \dot{X} &= \begin{bmatrix} \beta SI - \delta E \\ \delta E - \gamma I \\ \end{bmatrix} \\
\ \dot{X} &= \begin{bmatrix} \beta SI \\ 0 \\ \end{bmatrix} - \left( \begin{bmatrix} \delta E \\ \gamma I \\ \end{bmatrix} - \begin{bmatrix} 0 \\ \delta E \\ \end{bmatrix} \right) \\
\ \dot{X} &= F(x) - ( V^- (x) -V^+ (x) ) \\
\end{align*}
$$

Note that the 0 in
$F(x) = \begin{bmatrix} \beta SI \\ 0 \\ \end{bmatrix}$ exists because
$F$ only considers brand new infected (the flow from $S \rightarrow E$
and not $S \rightarrow I$). I.e. infected, not necessarily infectious.

We separate the equation into components to assist us in our $R_0$
calculations

For further simplicity, let:\
$$
F(x) = \begin{bmatrix} \beta SI \\ 0 \\ \end{bmatrix} = \begin{bmatrix} F_1 \\ F_2 \\ \end{bmatrix} 
$$

Also let:\
$$
V(x) = \begin{bmatrix} \delta E \\ \gamma I - \delta E \\ \end{bmatrix} = \begin{bmatrix} V_1 \\ V_2 \\ \end{bmatrix} 
$$

Find the Jacobians of F(x) and V(x) at the disease free equilibrium
(DFE):

Let the Jacobian of F(x) be **F**.

$$
\boldsymbol{F} = J_F (x) = \begin{bmatrix} 
\frac{\partial F_1}{\partial E} & \frac{\partial F_1}{\partial I} \\
\frac{\partial F_2}{\partial E} & \frac{\partial F_2}{\partial I} \\
\end{bmatrix}
= \begin{bmatrix} 
0 & \beta S \\
0 & 0 \\
\end{bmatrix}
$$

At DFE, $S = 1$

- This is found by our earlier definition of the DFE.
  - At the DFE for $(S,E,I,R) = (N,0,0,0)$
  - Since Population $"N"=1$ and $S=N$, then $S=1$
- So after subsituting $S=1$:

$$
J_F (x) 
= \begin{bmatrix} 
0 & \beta \\
0 & 0 \\
\end{bmatrix}
$$

Let the Jacobian of V(x) be **V**.

$$
\boldsymbol{V} = J_V (x) = \begin{bmatrix} 
\frac{\partial V_1}{\partial E} & \frac{\partial V_1}{\partial I} \\
\frac{\partial V_2}{\partial E} & \frac{\partial V_2}{\partial I} \\
\end{bmatrix}
= \begin{bmatrix} 
\delta & 0 \\
-\delta & \gamma \\
\end{bmatrix}
$$

Another way to think about it:
$\dot{X} = (f-v) \begin{bmatrix} E \\ I \end{bmatrix} = (f-v)X$

Now find the NGM.

$NGM = \boldsymbol{F} \boldsymbol{V}^{-1}$

The NGM for this is $$
\boldsymbol{F} = \begin{bmatrix} 
0 & \beta \\
0 & 0 \\
\end{bmatrix}
$$

and by the rule: for matrix
$M = \begin{bmatrix} a & b \\ c & d \\ \end{bmatrix}$ the inverse
$M^{-1} = \frac{1}{ad-bc} \begin{bmatrix} d & -b \\ -c & a \\ \end{bmatrix}$

Then for $\boldsymbol{V} ^{-1}$ we get $$
\boldsymbol{V} ^{-1} = \frac{1}{\delta \gamma} \begin{bmatrix} 
\gamma & 0 \\
\delta & \delta \\
\end{bmatrix}
$$

$$
\begin{align*}
\ \boldsymbol{F} \boldsymbol{V} ^{-1} &= \begin{bmatrix} 0 & \beta \\ 0 & 0 \\ \end{bmatrix}
\frac{1}{\delta \gamma} 
\begin{bmatrix} \gamma & 0 \\ \delta & \delta \\ \end{bmatrix} \\
\ &= \begin{bmatrix} 0 & \beta \\ 0 & 0 \\ \end{bmatrix}
\begin{bmatrix} \frac{1}{\delta} & 0 \\ \frac{1}{\gamma} & \frac{1}{\gamma} \\ \end{bmatrix} \\
\ &= \begin{bmatrix} \frac{\beta}{\gamma} & \frac{\beta}{\gamma} \\ 0 & 0 \\ \end{bmatrix} \\
\end{align*}
$$

Refer back to the formula in (*Chapter* \@ref(sec:dfeesa)), where $det(J-\lambda I_n) = 0$. $R_0$ is the spectral radius (i.e. largest eigenvalue) of $\ \boldsymbol{F} \boldsymbol{V} ^{-1}$. 


$$
det \left( \begin{bmatrix} 
\frac{\beta}{\gamma} - \lambda & \frac{\beta}{\gamma} \\
0 & - \lambda \\
\end{bmatrix} \right)
= - \lambda \left( \frac{\beta}{\gamma} - \lambda \right)
$$

Let $- \lambda \left( \frac{\beta}{\gamma} - \lambda \right) = 0$.

So $\lambda = 0$ and $\lambda = \frac{\beta}{\gamma}$. The latter is the
largest eigenvalue, so $R_0 = \lambda = \frac{\beta}{\gamma}$.

## Solving the SEIR Model with Birth and Death

In this version of the SEIR model, demographic effects such as births and deaths (also known as **vital dynamics**) are included to increase model realism. 

- $\mu N$ represents **births**  

- $\mu$ represents **deaths**

The birth term $\mu N$ adds to the susceptible population, while the deaths occur at a rate $\mu$ across the four compartments.

```{r seirvitaldiagram, echo=FALSE, fig.align='center', engine='tikz', out.width='70%', fig.ext='png', fig.cap='The SEIR compartmental model.'}
\begin{tikzpicture}[node distance=3.2cm,>=stealth,thick]

% Nodes
\node[draw, minimum width=2cm, minimum height=1cm] (S) {$S$};
\node[draw, minimum width=2cm, minimum height=1cm, right of=S] (E) {$E$};
\node[draw, minimum width=2cm, minimum height=1cm, right of=E] (I) {$I$};
\node[draw, minimum width=2cm, minimum height=1cm, right of=I] (R) {$R$};

% empty nodes
\node[draw=none, minimum width=2cm, minimum height=1cm, left of=S] (muN) {};
\node[draw=none, minimum width=2cm, minimum height=1cm, below of=I, yshift=30] (muI) {};
\node[draw=none, minimum width=2cm, minimum height=1cm, below of=E, yshift=30] (muE) {};
\node[draw=none, minimum width=2cm, minimum height=1cm, below of=R, yshift=30] (muR) {};

% Arrows
\draw[->] (S) -- (E) node[midway, above] {$\frac{\beta S I}{N}$};
\draw[->] (E) -- (I) node[midway, above] {$\sigma$};
\draw[->] (I) -- (R) node[midway, above] {$\gamma I$};

% Arrows for vital dynamics
\draw [->] (muN) -- node[midway, above] {$\mu N$} (S);
\draw [->] (E) -- node[midway, right] {$\mu E$} (muE);
\draw [->] (I) -- node[midway, right] {$\mu I$} (muI);
\draw [->] (R) -- node[midway, right] {$\mu R$} (muR);

\end{tikzpicture}
```

The four **differential equations** can then be constructed. However, for the next generation model, we only care about $\dot{E}$ and $\dot{I}$, since they represent the infected compartments. Also note that $S+E+I+R=N$.

\begin{align*}
\dot{S} &= \mu N - \frac{\beta SI}{N} \\
\dot{E} &= \frac{\beta SI}{N} - (\sigma + \mu)E \\
\dot{I} &= \sigma E - (\gamma + \mu)I
\dot{R} &= \gamma I - \mu R \\
\end{align*} 

At the disease-free equilibrium (DFE), there are no infections ($E = 0$ and $I = 0$).
From the first equation, $\dot{S} = 0$ when $S = N$, meaning the entire population is susceptible.
We use this equilibrium to linearize the system and separate infection terms ($F(x)$) from other transition terms ($V(x)$).

Next Generation Model: 
$$
\begin{align*}
\dot(x) &= F(x) - V(x) \\
&= \begin{bmatrix} 
\frac{\beta SI}{N} \\ 
0 
\end{bmatrix} - 
\begin{bmatrix}
(\sigma + \mu)E \\
(\gamma + \mu)I - \sigma E
\end{bmatrix}
\end{align*}
$$

Here, the first vector $F(x)$ captures new infections — in this case, the flow from the susceptible compartment $S$ to the exposed compartment $E$.
The second vector, $V(x)$, represents all other movements between infected compartments (progression, recovery, and death).

The Jacobian of $F(x)$ is 
$$
\begin{bmatrix}
0 & \frac{\beta S}{N} \\
0 & 0
\end{bmatrix}
$$ 

And since at the DFE S is equal to N, 
$$
\textbf{F} = \begin{bmatrix} 0 &\beta \\0&0 \end{bmatrix}
$$
The Jacobian of $V(x)$ is 
$$
\textbf{V} = \begin{bmatrix} \sigma + \mu & 0 \\ -\sigma & \gamma + \mu \end{bmatrix}
$$ 
Next gen matrix is 
$$
\begin{align*}
FV^{-1} &= 
\begin{bmatrix}
0 & \beta \\
0 & 0
\end{bmatrix}
\frac{1}{(\sigma + \mu)(\gamma + \mu)}
\begin{bmatrix}
\gamma + \mu & 0 \\
\sigma & \sigma + \mu
\end{bmatrix} \\
&= 
\begin{bmatrix}
\frac{\beta \sigma}{(\sigma + \mu)(\gamma + \mu)} & \frac{\beta}{\gamma + \mu} \\
0 & 0
\end{bmatrix}
\end{align*}
$$
Multiplying $F$ by $V^{-1}$ captures how many new infections one infected individual generates in each compartment over their infectious period.

The resulting matrix describes the expected number of new infections caused by an exposed or infectious person.
The basic reproduction number $R_0$ is given by the the largest eigenvalue of the next generation matrix.

The largest eigenvalue is : 
$\frac{\beta \sigma}{(\sigma + \mu)(\gamma +\mu)} = R_0$

This value shows how the disease’s ability to spread depends not only on transmission ($\beta$) and recovery ($\gamma$), but also on the rates of progression ($\sigma$) and death ($\mu$).
If $\mu = 0$, meaning no births or deaths occur, this expression simplifies to $R_0 = \frac{\beta}{\gamma}$ which is the classic SIR result.

References: [@blackwood2018]


## Visualizing the SEIR Models

Below, we have time series plots displaying the two examples we have looked at in this chapter. We used the following parameters in these plots: 

- initial population size: $N = 500$

- transmission rate: $\beta = 0.4$

- progression rate from exposed to infected: $\delta = \sigma = 0.27$ 

- recovery rate: $\gamma = 0.10$

- death rate: $\mu = 0.0001$ (only used in Figure \@ref(fig:seirvitalplot))

Figures \@ref(fig:seirplot) and \@ref(fig:seirvitalplot) visualize the effects of vital dynamics (births, deaths) on a disease model, despite the rest of the parameters being the same. Also, note the difference in the time scales between the plots. The plot without vital dynamics (Figure \@ref(fig:seirplot)) is simulated over a period of 75 days, while the plot including vital dynamics (Figure \@ref(fig:seirvitalplot)) is simulated over a period of 1 year.
 

```{r seirplot, echo=FALSE, fig.align='center', out.width='70%', fig.cap='Time series plot of SEIR model without vital dynamics at endemic equilibrium, simulated with parameter values.'}


# SEIR model without vital dynamics
seir_model <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {
    
    # Differential equations (from Chapter 5.4)
    dS <- - beta * S * I 
    dE <- beta * S * I - delta * E
    dI <- delta * E - gamma * I
    dR <- gamma * I 
    
    list(c(dS, dE, dI, dR))
    
  })
}
# ---- PARAMETERS (you may edit these if your chapter has specific values) ----

N <- 500

seir_param <- c(
  N = N, 
  beta = 0.4,   # transmission 0.01
  delta = 0.27, # progression rate of exposed to infected  0.09
  gamma = 0.10 # infected to recovery 0.05
)


# ---- INITIAL CONDITIONS ----

seir_initial <- c(
  S = N - 1,
  E = 1,
  I = 0,
  R = 0
)

# ---- TIME SEQUENCE ----

times <- seq(0, 75, by = 1) 

# ---- SOLVE ODE ----

seir_output <- deSolve::ode(
  y = seir_initial,
  times = times,
  func = seir_model,
  parms = seir_param
)

seir_results <- as.data.frame(seir_output)

# ---- RESHAPE FOR GGPLOT ----

seir_results <- tidyr::pivot_longer(
  seir_results,
  cols = c(S, E, I, R),
  names_to = "Compartment",
  values_to = "Population"
)

# ---- PLOT ----

ggplot(seir_results, aes(x = time, y = Population, color = Compartment)) +
  geom_line(linewidth = 1.2) +
  labs(
    subtitle = paste0(
      "N = ", N,
      ", β = ", seir_param['beta'],
      ", δ = ", seir_param['delta'],
      ", γ = ", seir_param['gamma']
    ),
    x = "Time (days)",
    y = "Population (N)"
  ) +
  scale_color_manual(values = c("S" = "cornflowerblue", 
                                "E" = "darkgoldenrod1",
                                "I" = "tomato", 
                                "R" = "dodgerblue4")) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.subtitle = element_text(hjust = 0.5)
  )

```

```{r seirvitalplot, echo=FALSE, fig.align='center', out.width='70%', fig.cap='Time series plot of SEIR model with vital dynamics at endemic equilibrium, simulated with parameter values.'}

# Define the SEIR model function
seir_vital_model <- function(time, state, parameters) {
  with(as.list(c(state, parameters)), {

    # Differential equations (from Chapter 5.4)
    dS <- mu*N - (beta * S * I) / N
    dE <- (beta * S * I) / N - (sigma + mu) * E
    dI <- sigma * E - (gamma + mu) * I
    dR <- gamma * I - mu * R
    
    list(c(dS, dE, dI, dR)) # Return the rates of change
  })
}

# choose some starting N 
N <- 500 

seir_vital_param <- c(N = N, 
                      beta = 0.4,   # transmission
                      sigma = 0.27,    # progression E→I 
                      gamma = 0.10,    # recovery
                      mu = 0.0001       # birth/death rate
                      ) 


# Initial conditions: small outbreak with small E, I, and S slightly below DFE
seir_vital_initial <- c(S = N - 5 - 1, E = 0, I = 1, R = 5)

# Time points to solve for (0 to 2-years simulation (daily steps)
times <- seq(0, 365, by = 1)

# Solve the differential equations
seir_vital_output <- ode(y = seir_vital_initial, times = times, func = seir_vital_model, parms = seir_vital_param)

# Convert to data frame
seir_vital_results <- as.data.frame(seir_vital_output)

# Calculate derived quantities
seir_vital_results <- seir_vital_results %>%
  mutate(N = S + E + I + R, Day = time)

# PLOT TIME SERIES PLOT
seir_vital_results %>%
  pivot_longer(cols = c(S, E, I, R), 
               names_to = "Compartment", 
               values_to = "Count") %>%
  ggplot(aes(x = Day, y = Count, color = Compartment)) +
  geom_line(linewidth = 1.2, alpha = 0.8) +
  labs(subtitle = paste("β =", seir_vital_param["beta"], 
                        ", σ =", seir_vital_param["sigma"],
                        ", μ =", seir_vital_param["mu"],
                        ", γ = ", seir_vital_param['gamma']       
                        ),
       x = "Time (days)", y = "Population (N)") +
  scale_color_manual(values = c("S" = "cornflowerblue", 
                                "E" = "darkgoldenrod1",
                                "I" = "tomato", 
                                "R" = "dodgerblue4")) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.subtitle = element_text(hjust = 0.5)
  )

```
