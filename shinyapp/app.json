[{"name":"App.R","content":"# app.R\nlibrary(shiny)\nlibrary(deSolve)\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(scales)\nlibrary(bslib)\n\n# ---- Helpers ----\nsir_ode <- function(t, state, parms) {\n  with(as.list(c(state, parms)), {\n    dS <- -beta * S * I\n    dI <-  beta * S * I - gamma * I\n    dR <-  gamma * I\n    list(c(dS, dI, dR))\n  })\n}\n\nrun_sir <- function(S0, I0, R0, beta, gamma, days, N) {\n  sum0 <- S0 + I0 + R0\n  if (!is.finite(sum0) || sum0 <= 0) sum0 <- 1\n  S0n <- S0 / sum0; I0n <- I0 / sum0; R0n <- R0 / sum0\n  \n  y0 <- c(S = S0n, I = I0n, R = R0n)\n  times <- seq(0, days, by = 0.1)\n  parms <- c(beta = beta, gamma = gamma)\n  \n  out <- ode(y = y0, times = times, func = sir_ode, parms = parms, method = \"rk4\")\n  out <- as.data.frame(out)\n  \n  out |>\n    mutate(S_count = S * N, I_count = I * N, R_count = R * N)\n}\n\nnice_number <- function(x) {\n  if (!is.finite(x)) return(\"\")\n  number(x, accuracy = ifelse(abs(x) >= 1000, 1, 0.01), scale_cut = cut_short_scale())\n}\n\n# ---- UI ----\nui <- page_fluid(  # bslib v5 layout\n  theme = bs_theme(version = 5, bootswatch = \"flatly\"),\n  title = \"SIR Modelling Dashboard\",\n  layout_sidebar(\n    sidebar = sidebar(\n      h4(\"Initial Conditions\"),\n      sliderInput(\"S0\", \"Initial susceptible (proportion)\", min = 0, max = 1, value = 0.99, step = 0.001),\n      sliderInput(\"I0\", \"Initial infectious (proportion)\",  min = 0, max = 1, value = 0.01, step = 0.001),\n      sliderInput(\"R0_init\", \"Initial recovered (proportion)\", min = 0, max = 1, value = 0.00, step = 0.001),\n      div(style = \"margin-top:-8px; color:#666;\", textOutput(\"sum_check\")),\n      tags$hr(),\n      h4(\"Parameters\"),\n      sliderInput(\"beta\",  HTML(\"&beta;: transmission rate (per day)\"), min = 0.05, max = 1.5, value = 0.30, step = 0.01),\n      sliderInput(\"gamma\", HTML(\"&gamma;: recovery rate (per day)\"),    min = 0.05, max = 1.0, value = 0.10, step = 0.01),\n      sliderInput(\"days\", \"Simulation horizon (days)\", min = 30, max = 360, value = 160, step = 5),\n      numericInput(\"N\", \"Population size (for counts)\", value = 100000, min = 1, step = 1000),\n      checkboxInput(\"logy\", \"Log scale (y-axis)\", value = FALSE),\n      actionButton(\"reset\", \"Reset defaults\"),\n      tags$hr(),\n      downloadButton(\"dl_csv\", \"Download CSV\")\n    ),\n    card(\n      card_header(h3(\"S, I, R over time\", class = \"m-0\")),\n      card_body(plotOutput(\"sir_plot\", height = \"480px\"))\n    ),\n    # ---- HERE: Key Metrics + Notes cards ----\n    layout_columns(\n      col_widths = c(6, 6),\n      card(\n        card_header(h4(\"Key Metrics\", class = \"m-0\")),\n        card_body(\n          fluidRow(\n            column(6, div(class = \"border rounded p-3 mb-2\",\n                          strong(\"Basic reproduction number (R0)\"),\n                          div(style = \"font-size:1.4rem;\", textOutput(\"R0txt\")))),\n            column(6, div(class = \"border rounded p-3 mb-2\",\n                          strong(\"Mean infectious period\"),\n                          div(style = \"font-size:1.4rem;\", textOutput(\"infper\"))))\n          ),\n          fluidRow(\n            column(6, div(class = \"border rounded p-3 mb-2\",\n                          strong(\"Peak infectious (count)\"),\n                          div(style = \"font-size:1.4rem;\", textOutput(\"ipeak\")))),\n            column(6, div(class = \"border rounded p-3 mb-2\",\n                          strong(\"Time of peak (days)\"),\n                          div(style = \"font-size:1.4rem;\", textOutput(\"tpeak\"))))\n          )\n        )\n      ),\n      card(\n        card_header(h4(\"Notes\", class = \"m-0\")),\n        card_body(\n          tags$ul(\n            tags$li(HTML(\"ODE system: &dot;S = −&beta;SI, &nbsp; &dot;I = &beta;SI − &gamma;I, &nbsp; &dot;R = &gamma;I.\")),\n            tags$li(\"Proportions are normalized internally if they do not sum to 1.\"),\n            tags$li(HTML(\"R0 = &beta; / &gamma;. Time units are days.\"))\n          )\n        )\n      )\n    )\n  )\n)\n\n# ---- Server ----\nserver <- function(input, output, session) {\n  \n  observeEvent(input$reset, {\n    updateSliderInput(session, \"S0\", value = 0.99)\n    updateSliderInput(session, \"I0\", value = 0.01)\n    updateSliderInput(session, \"R0_init\", value = 0.00)\n    updateSliderInput(session, \"beta\", value = 0.30)\n    updateSliderInput(session, \"gamma\", value = 0.10)\n    updateSliderInput(session, \"days\", value = 160)\n    updateCheckboxInput(session, \"logy\", value = FALSE)\n    updateNumericInput(session, \"N\", value = 100000)\n  })\n  \n  output$sum_check <- renderText({\n    s <- input$S0 + input$I0 + input$R0_init\n    if (abs(s - 1) < 1e-6) sprintf(\"Sum: %.3f (OK)\", s)\n    else sprintf(\"Sum: %.3f — will be normalized.\", s)\n  })\n  \n  sol <- reactive({\n    run_sir(\n      S0 = input$S0, I0 = input$I0, R0 = input$R0_init,\n      beta = input$beta, gamma = input$gamma,\n      days = input$days, N = input$N\n    )\n  })\n  \n  output$R0txt  <- renderText(sprintf(\"%.3f\", input$beta / input$gamma))\n  output$infper <- renderText(sprintf(\"%.2f days\", 1 / input$gamma))\n  \n  observe({\n    df <- sol()\n    i_idx <- which.max(df$I_count)\n    output$ipeak <- renderText(nice_number(df$I_count[i_idx]))\n    output$tpeak <- renderText(sprintf(\"%.1f\", df$time[i_idx]))\n  })\n  \n  output$sir_plot <- renderPlot({\n    df <- sol() |>\n      select(time, S = S_count, I = I_count, R = R_count) |>\n      pivot_longer(-time, names_to = \"Compartment\", values_to = \"Count\")\n    \n    lab_fun <- label_number(scale_cut = cut_short_scale())\n    \n    ggplot(df, aes(x = time, y = Count, color = Compartment)) +\n      geom_line(linewidth = 1.2) +\n      scale_color_manual(values = c(S = \"#1f77b4\", I = \"#d62728\", R = \"#2ca02c\")) +\n      labs(x = \"Time (days)\", y = \"Number of individuals\",\n           title = sprintf(\"SIR dynamics (N = %s, R0 = %.2f)\",\n                           nice_number(input$N), input$beta / input$gamma)) +\n      theme_minimal(base_size = 14) +\n      theme(legend.position = \"top\",\n            plot.title.position = \"plot\",\n            plot.title = element_text(face = \"bold\")) +\n      { if (input$logy) scale_y_log10(labels = lab_fun)\n        else scale_y_continuous(labels = lab_fun) }\n  })\n  \n  output$dl_csv <- downloadHandler(\n    filename = function() {\n      paste0(\"sir_solution_N\", input$N, \"_R0_\", sprintf(\"%.2f\", input$beta / input$gamma), \".csv\")\n    },\n    content = function(file) {\n      df <- sol() |>\n        select(time, S_prop = S, I_prop = I, R_prop = R, S_count, I_count, R_count)\n      write.csv(df, file, row.names = FALSE)\n    }\n  )\n}\n\nshinyApp(ui, server)\n","type":"text"}]
